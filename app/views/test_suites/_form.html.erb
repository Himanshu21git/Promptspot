<%= form_with(model: @test_suite, local: true, data: { controller: "prompt-panel", "prompt-panel-test-suite-id-value": @test_suite.id, turbo_frame: false }, class: 'w-full xl:w-2/3') do |form| %>
  <% if @test_suite.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@test_suite.errors.count, "error") %> prohibited this test_suite from being saved:</h2>

      <ul>
        <% @test_suite.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="field flex flex-col my-4">
    <%= form.label :name %>
    <%= form.text_field :name, class: "rounded-md border-gray-300 text-lg w-full md:w-72", placeholder: "Name this test" %>
  </div>
  <hr/>
  <div class="flex flex-row items-start justify-between my-4 py-8">
    <div class="field flex flex-col inline-flex grow">
      <%= form.hidden_field :prompt_ids, multiple: true, data: { "prompt-panel-target": 'promptIds' } %>
      <div class="flex flex-row items-center">
        <% if @prompts.length == 0 %>
          <button type="button" data-action="click->prompt-panel#openNewPrompt" class="items-center rounded-lg py-3 px-5 bg-white border border-blue-200 text-blue-600 hover:bg-gray-50 inline-block font-medium shadow-md">
            Create a prompt
          </button>
        <% else %>
          <button type="button" data-action="click->prompt-panel#openPrompt" class="items-center rounded-lg py-3 px-5 bg-white border border-blue-200 text-blue-600 hover:bg-gray-50 inline-block font-medium shadow-md">
            Select Prompt(s)
          </button>
          <div data-action="click->prompt-panel#openNewPrompt" class="ml-4 text-base cursor-pointer hover:underline text-blue-600">
            or create a new one
          </div>
        <% end %>
      </div>
      <div data-prompt-panel-target="selectedPrompts" class="mt-6 flex flex-wrap">
        <!-- Selected prompts will be listed here -->
      </div>
    </div>
    <p class="ml-12 text-gray-400 text-sm text-right w-72 flex-shrink-0">
      <% if @prompts.length == 0 %>
        Create your first prompt. We'll test your input(s) against this and deliver the results to you.
      <% else %>
        Select your "base" prompt(s). We'll independently test your inputs against these.
      <% end %>
    </p>
    <hr/>
  </div>
  <hr/>
  <div class="flex flex-row items-start justify-between my-4 py-8">
    <div class="field flex flex-col inline-flex grow">
      <%= form.hidden_field :input_ids, multiple: true, data: { "prompt-panel-target": 'inputIds' } %>
      <div class="flex flex-row items-center">
        <% if @inputs.length == 0 %>
          <button type="button" data-action="click->prompt-panel#openNewInput" class="items-center rounded-lg py-3 px-5 bg-white border border-blue-200 text-blue-600 hover:bg-gray-50 inline-block font-medium shadow-md">
            Create an input
          </button>
        <% else %>
          <button type="button" data-action="click->prompt-panel#openInput" class="items-center rounded-lg py-3 px-5 bg-white border border-blue-200 text-blue-600 hover:bg-gray-50 inline-block font-medium shadow-md">
            Select Input(s)
          </button>
          <div data-action="click->prompt-panel#openNewInput" class="ml-4 text-base cursor-pointer hover:underline text-blue-600">
            or create an input
          </div>
        <% end %>
      </div>
      <div data-prompt-panel-target="selectedInputs" class="mt-6 flex flex-wrap">
        <!-- Selected inputs will be listed here -->
      </div>
    </div>
    <p class="ml-12 text-gray-400 text-sm text-right w-72 flex-shrink-0">
      Inputs are the values you want to test against your prompts. They can be anything from a single word to a full
      paragraph. Often times this includes dynamic values, such as user profile data.
    </p>
  </div>
  <hr/>
  <div class="mt-8" data-controller="model-picker">
    <h2 class="text-lg mb-6">Select a model</h2>
    <div data-model-picker-target="list" class="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-4">
      <% @models.each do |m| %>
        <div data-action="click->model-picker#selectModel" data-model-id="<%= m.id %>" class="model-picker-model border-gray-300 border rounded-md p-4 cursor-pointer mb-4 hover:bg-blue-50 flex inline-flex flex-col mr-3 cursor-pointer
  " data-model-picker-target="model">
          <p class="font-mono text-lg"><%= m.name %></p>
          <p class="text-sm text-gray-500 mt-2"><%= m.model_provider.name %></p>

          <p class="mt-2 text-gray-500"><%= m.description %></p>
        </div>
      <% end %>
    </div>
  </div>

  <div class="actions my-8 flex flex-row">
    <%= button_tag 'Save', type: "submit", data: { action: "save_for_later" }, class: 'cursor-pointer shadow-md mr-3 rounded-lg py-3 px-5 bg-blue-50 border border-blue-200 text-blue-600 hover:bg-white inline-block font-medium' %>
    <%= button_tag 'Save and run', type: "submit", data: { action: "run_now" }, class: 'shadow-md flex items-center justify-center rounded-md py-2 px-3 bg-green-50 border border-green-300 text-green-700 hover:bg-white font-medium cursor-pointer' %>
  </div>


  <div class="fixed inset-0 bg-black opacity-0" style=" pointer-events: none;" data-prompt-panel-target="overlay" data-action="click->prompt-panel#close"></div>

  <!-- Panel -->
  <div class="p-6 fixed right-0 top-0 h-screen md:w-1/3 sm:w-1/2 w-2/3 overflow-y-auto bg-white shadow-lg transform translate-x-full transition-transform duration-300 ease-in-out pointer-events-none opacity-0 shadow-lg" data-prompt-panel-target="panel">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl" data-prompt-panel-target="headline">
      </h2>
      <button type="button" data-prompt-panel-target="doneButton" data-action="click->prompt-panel#close" class="rounded-lg py-3 px-5 bg-blue-50 border border-blue-200 text-blue-600 hover:bg-white inline-block font-medium">
        Done
      </button>
    </div>
    <div data-prompt-panel-target="list">
      <div id="prompts" class="hidden">
        <% @prompts.each do |prompt| %>
          <div class="border-gray-300 border rounded-md p-4 cursor-pointer mb-4 hover:bg-blue-50"
               data-action="click->prompt-panel#selectPrompt"
               data-prompt-panel-target="prompt"
               data-prompt-id="<%= prompt.id %>">
            <p class="text-base mb-2 title"><%= prompt.title %></p>
            <p class="text-gray-600 text-sm font-mono"><%= prompt.prompt_versions.order(:version_number).last.text %></p>
          </div>
        <% end %>
      </div>
      <div id="inputs" class="hidden">
        <% @inputs.each do |input| %>
          <div class="border-gray-300 border rounded-md p-4 cursor-pointer mb-4 hover:bg-blue-50"
               data-action="click->prompt-panel#selectInput"
               data-prompt-panel-target="input"
               data-input-id="<%= input.id %>">
            <p class="text-base mb-2 title"><%= input.title %></p>
            <p class="text-gray-600 text-sm font-mono"><%= input.text %></p>
          </div>
        <% end %>
      </div>
      <div id="new_prompt" class="hidden">
        <%= render partial: 'prompts/mini-form', locals: { prompt: Prompt.new } %>
      </div>
    </div>
    <div id="new_input" class="hidden">
      <%= render partial: 'inputs/mini-form', locals: { input: Input.new } %>
    </div>
  </div>
<% end %>
